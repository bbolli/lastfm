#!/bin/bash

# Usage: lastfm [-d] [-u] [-e]
#       -d: dry-run -- just show the differences
#       -u: update -- just update the feed; don't post to tumblr
#       -e: edit -- edit the last tumblr post (the post-id is in file $id)
#
# The default behavior is to add a new post if the <updated> date changed,
# or edit the current post if it didn't.

current=$HOME/public_html/lastfm.atom
old=$current.bak
new=$current.new
id=$current.id

input=$current; [[ -r $current ]] || input=/dev/null

function sorteddiff() {
    diff -ui <(sort $input) <(sort $new)
}

function updated() {
    sed -ne '/<updated>/s![ </>updated]!!gp' <$1 | head -n1
}

# get the current charts
charts >$new || exit $?

# exit if they didn't change
[[ -z "$(sorteddiff)" ]] && rm $new && exit

if [[ "$1" == -d ]]; then
    # show the difference in dry-run mode
    sorteddiff || true
else
    # update the current file
    [[ -r $current ]] && mv -f $current $old
    mv -f $new $current
    [[ "$1" == -u ]] && exit
    # edit the current post if the <updated> date is still the same
    if [[ "$1" == -e || -r $old && "$(updated $old)" == "$(updated $current)" ]]; then
        tumble -e "$(cat $id)" <$current
    else
        tumble <$current | tee $id
        sed -i -ne '/ok/s/[^0-9]\+//gp' $id
    fi
fi
